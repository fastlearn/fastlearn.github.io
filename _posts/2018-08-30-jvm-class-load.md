---
layout: post
title: Java虚拟机 - 类加载机制
categories: Java虚拟机
tags: [Java虚拟机]
---

Java虚拟机把描述类的数据从class文件加载到内存，并对数据进行检验、转换解析和初始化，最终形成可以被Java虚拟机使用的Java类型，这就是类的加载机制。

## 类的加载时机

类的生命周期包括加载、验证、解析、准备、初始化、使用和卸载7个阶段。其中验证、解析、准备统称为连接。

![类的生命周期](/images/jvm/class-lifecycle.png)

加载、验证、准备、初始化和卸载5个阶段的顺序是确定的，类的加载必须按照这个顺序开始，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后在开始，这是为了支持Java语言运行时绑定。

Java虚拟机规范规定类加载过程的初始化阶段有且只有5种情况对类进行初始化(而加载、验证、准备自然在此之前开始)：
- 遇到new(使用new关键字新建对象)、getstatic(读取静态变量)、pustatic(设置静态变量)或invokestatic(调用静态方法)这4条字节码时，如果类没有初始化，则需要对类进行初始化。
- 对类进行反射调用的时候，如果类没有初始化，则需要对类进行初始化
- 当初始化一个类的时候，如果父类没有初始化，则需要先对父类进行初始化
- Java虚拟机启动的时候用户需要指定一个主类，Java虚拟机会先初始化这个主类
- 当使用JDK1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个方法句柄对应的类没有进行初始化，则需要对其进行初始化

## 类加载的过程

类加载的过程包括加载、验证、准备、解析和初始化5个阶段。

### 加载

在加载阶段Java虚拟机要完成三件事情
- 1、通过类的全限定名来获取定义此类的二进制字节流。
- 2、将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
- 3、在内存中生成代表这个类的Class对象，通过这个Class对象获取这个类的各种数据

### 验证

### 准备

### 解析

### 初始化

